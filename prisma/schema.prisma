generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique
  password      String?   // Added for Credentials provider
  fullName      String    @map("full_name")
  role          String    @default("user") // "admin" or "user"
  walletAddress String?   @map("wallet_address")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")

  contracts     Contract[]
  approvals     Approval[]
  documents     Document[]

  accounts      Account[]
  sessions      Session[]

  @@map("users")
}

model Account {
  id                 String  @id @default(cuid())
  userId             String  @map("user_id") @db.Uuid
  type               String
  provider           String
  providerAccountId  String  @map("provider_account_id")
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id") @db.Uuid
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Contract {
  id          String   @id @default(uuid()) @db.Uuid
  title       String
  description String?
  contractMode String   @default("onchain") @map("contract_mode") // onchain, offchain
  status      String   @default("pending") // pending, completed, rejected
  threshold   Int      @default(1)
  creatorId   String?  @map("creator_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  creator     User?             @relation(fields: [creatorId], references: [id])
  documents   Document[]
  approvals   Approval[]
  proofs      BlockchainProof[]

  @@map("contracts")
}

model Document {
  id          String   @id @default(uuid()) @db.Uuid
  contractId  String?  @map("contract_id") @db.Uuid
  
  fileName    String   @map("file_name")
  mimeType    String?  @map("mime_type")
  fileSize    BigInt?  @map("file_size")
  
  fileHash    String   @map("file_hash") // SHA-256 for integrity
  
  storageType String   @map("storage_type") // e.g. 'supabase', 'ipfs'
  storagePath String   @map("storage_path") // bucket path or CID
  
  uploadedBy  String?  @map("uploaded_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")

  contract    Contract?         @relation(fields: [contractId], references: [id])
  uploader    User?             @relation(fields: [uploadedBy], references: [id])
  proofs      BlockchainProof[]

  @@map("documents")
}

model BlockchainProof {
  id              String   @id @default(uuid()) @db.Uuid
  contractId      String?  @map("contract_id") @db.Uuid
  documentId      String?  @map("document_id") @db.Uuid
  
  transactionHash String   @map("transaction_hash")
  blockNumber     BigInt?  @map("block_number")
  networkName     String?  @map("network_name")
  contractAddress String?  @map("contract_address")
  
  provenAt        DateTime @default(now()) @map("proven_at")

  contract        Contract? @relation(fields: [contractId], references: [id])
  document        Document? @relation(fields: [documentId], references: [id])

  @@map("blockchain_proofs")
}

model Approval {
  id              String   @id @default(uuid()) @db.Uuid
  contractId      String?  @map("contract_id") @db.Uuid
  userId          String?  @map("user_id") @db.Uuid
  
  status          String   @default("pending") // pending, approved, rejected
  signature       String?  // Cryptographic signature
  
  approvedAt      DateTime? @map("approved_at")
  transactionHash String?   @map("transaction_hash")

  contract        Contract? @relation(fields: [contractId], references: [id])
  user            User?     @relation(fields: [userId], references: [id])

  @@map("approvals")
}
